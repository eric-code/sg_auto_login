name: Build Windows EXE

on:
  push:
    branches: [ "main" ]
  # 允许手动在网页端触发构建（方便测试）
  workflow_dispatch:

permissions:
  contents: write  # 必须开启写入权限，否则无法发布 Release

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip' # ✨ 新增：开启 pip 缓存，第二次构建速度会飞快，省配额！

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt

    - name: Build EXE
      # ✨ 优化：增加 --clean 清理缓存，防止打包出现玄学问题
      run: |
        pyinstaller -F -n SGAutoLoginTool --collect-all ddddocr --clean main.py

    # ----------------------------------------------------------------
    # 方式 1: 传统的 Artifact 上传
    # ----------------------------------------------------------------
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SGAutoLoginTool_Windows
        path: dist/SGAutoLoginTool.exe
        retention-days: 5

    # ----------------------------------------------------------------
    # 方式 2: 自动发布到 Releases
    # 这样可以使用镜像加速链接下载，或者直接下载也会快很多
    # ----------------------------------------------------------------
    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/') # 只有打 tag 时才触发
      with:
        files: dist/SGAutoLoginTool.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
