name: Build and Release Windows EXE

on:
  push:
    tags:
      - 'v*'
  # 保留手动触发，方便测试
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt

    - name: Build EXE
      run: |
        # 使用 -F 打包成单文件
        pyinstaller -F -n SGAutoLoginTool --collect-all ddddocr --clean main.py

    - name: Package files
      run: |
        # 创建临时文件夹
        New-Item -ItemType Directory -Force -Path package_dist
        
        # 复制 EXE 文件
        Copy-Item -Path "dist\SGAutoLoginTool.exe" -Destination "package_dist\"
        
        # 复制配置文件模板并改名为用户直接可用的名字
        if (Test-Path "config_template.json") {
            Copy-Item -Path "config_template.json" -Destination "package_dist\config.json"
        }
        
        # 压缩为 zip
        Compress-Archive -Path "package_dist\*" -DestinationPath "SGAutoLoginTool_Windows.zip"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SGAutoLoginTool_Windows_Zip
        path: SGAutoLoginTool_Windows.zip
        retention-days: 5

    - name: Create Release
      uses: softprops/action-gh-release@v2
      # 只有在确实是推送 tag 时才执行 Release 步骤
      if: startsWith(github.ref, 'refs/tags/')
      with:
        # 指定要上传的文件
        files: SGAutoLoginTool_Windows.zip
        # 自动生成 Release Note (提取 commit log)
        generate_release_notes: true
        # 如果是预发布版本（如 v1.0.0-beta），可以设为 true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}